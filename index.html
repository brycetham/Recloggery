<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>Recloggery</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap4.min.css">
  </head>
  <body>
    <div class="container" style="padding:20px">
        <div class="row">
            <div class="col">
                <h1><span id="username">Battlestriker123</span>'s Recommendations</h1>
                <p>powered by <a href="http://backloggery.com">Backloggery</a></p>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <table class="table table-hover" id="game-table">
                    <thead>
                        <tr>
                            <th>Game</th>
                            <th>Score</th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="game-list">
                    </tbody>
                </table>
                <div class="progress" id="loading">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuemax="100" style="width: 100%">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap4.min.js"></script>
    
    <script>
        $(document).ready(function () {
            getGames("", 0);
        });
        
        function getGames(content, ajid) {
			var proxy = 'https://cors.now.sh/';
            $.get(proxy + 'http://backloggery.com/ajax_moregames.php?user=' + $('#username').text() + '&alpha=1&ajid=' + ajid, function(data) {
                var html = $.parseHTML(data);
                var next = true;
                $.each(html, function(i, gamebox) {
                    if ($(gamebox).hasClass('systemend')) {
                        $('#loading').html("");
                        $('#game-list').html(content);
                        initializeTable();
                        next = false;
                        return;
                    } else if (i % 2 != 0) {
                        var title = $($('b', gamebox)[0]).text();
                        var system = $($('b', gamebox)[1]).text().trim()

                        var score = $($('.lift', gamebox)[1]).attr('src');						
                        score = score ? score[7] : 0;
                        var stars = ['N/A', '★☆☆☆☆', '★★☆☆☆', '★★★☆☆', '★★★★☆', '★★★★★'];
                       
                        var comment = $($('[id^=comments]', gamebox)[0]).text();
                        comment = comment ? comment : '(no review available)';
						                       
                        if (score) {
                            content += "<tr><td><b>" + title + "</b> <small><span class=\"badge badge-secondary\">" + system + "</span><br />" + comment + "</small></td><td>" + stars[score] + "</td><td>" + title + "</td><td>" + system + "</td></tr>";
                        }
                    }
                });
                if (next) {
                    getGames(content, ajid + 50);
                }
            });
        }
    
        function initializeTable() {
            $('#game-table').DataTable( {
                "pagingType": "simple",
                "columnDefs": [
                    {
                        "targets": [ 0, 1 ],
                        "visible": true,
                        "searchable": false
                    },
                    {
                        "targets": [ 2, 3 ],
                        "visible": false,
                        "searchable": true
                    }
                ]
            } );
        }
    </script>
    
  </body>
</html>
